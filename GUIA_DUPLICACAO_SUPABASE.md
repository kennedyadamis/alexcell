# Guia Completo para Duplica√ß√£o do Projeto AlexCell no Supabase

## Vis√£o Geral
Este guia cont√©m todas as informa√ß√µes necess√°rias para recriar completamente o projeto AlexCell em uma nova inst√¢ncia do Supabase.

## üìã Estrutura do Banco de Dados

### Tabelas Principais

#### 1. **service_orders** - Ordens de Servi√ßo
```sql
CREATE TABLE service_orders (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    customer_id BIGINT REFERENCES customers(id),
    device_type TEXT,
    brand_id BIGINT REFERENCES brands(id),
    model TEXT,
    problem_description TEXT,
    status TEXT DEFAULT 'received',
    estimated_delivery_date TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    store_id BIGINT REFERENCES stores(id),
    pattern_lock_value TEXT,
    payment_method TEXT,
    products JSONB,
    serial_number TEXT,
    solution TEXT
);
```

#### 2. **customers** - Clientes
```sql
CREATE TABLE customers (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    full_name TEXT NOT NULL,
    phone TEXT,
    birth_date DATE,
    address JSONB,
    user_id UUID REFERENCES auth.users(id),
    email TEXT,
    cpf TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now())
);
```

#### 3. **products** - Produtos
```sql
CREATE TABLE products (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    name TEXT NOT NULL,
    description TEXT,
    price NUMERIC(10,2) NOT NULL,
    cost_price NUMERIC(10,2),
    stock_quantity INTEGER DEFAULT 0,
    category_id BIGINT REFERENCES categories(id),
    brand_id INTEGER REFERENCES brands(id),
    barcode TEXT UNIQUE,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    store_id BIGINT REFERENCES stores(id)
);
```

#### 4. **sales** - Vendas
```sql
CREATE TABLE sales (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    customer_id BIGINT REFERENCES customers(id),
    total_amount NUMERIC(10,2) NOT NULL,
    payment_method TEXT,
    sale_date TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    items JSONB NOT NULL,
    user_id UUID REFERENCES auth.users(id),
    store_id BIGINT REFERENCES stores(id),
    service_order_id BIGINT REFERENCES service_orders(id)
);
```

#### 5. **cash_registers** - Caixas
```sql
CREATE TABLE cash_registers (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    opened_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    closed_at TIMESTAMP WITH TIME ZONE,
    opening_balance NUMERIC DEFAULT 0,
    closing_balance NUMERIC,
    counted_balance NUMERIC,
    difference NUMERIC,
    status TEXT DEFAULT 'open',
    notes TEXT,
    opened_by_user_id UUID REFERENCES auth.users(id),
    closed_by_user_id UUID REFERENCES auth.users(id),
    store_id BIGINT REFERENCES stores(id)
);
```

#### 6. **cash_register_entries** - Movimenta√ß√µes do Caixa
```sql
CREATE TABLE cash_register_entries (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    cash_register_id BIGINT REFERENCES cash_registers(id),
    sale_id BIGINT REFERENCES sales(id),
    type TEXT NOT NULL,
    amount NUMERIC NOT NULL,
    payment_method TEXT,
    description TEXT,
    user_id UUID REFERENCES auth.users(id),
    store_id UUID,
    cost NUMERIC DEFAULT 0.00,
    service_order_id BIGINT REFERENCES service_orders(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### 7. **warranties** - Garantias
```sql
CREATE TABLE warranties (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    service_order_id BIGINT REFERENCES service_orders(id),
    customer_id BIGINT REFERENCES customers(id),
    warranty_start_date DATE NOT NULL,
    warranty_end_date DATE NOT NULL,
    warranty_terms TEXT,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    warranty_period_days INTEGER DEFAULT 90
);
```

#### 8. **stores** - Lojas
```sql
CREATE TABLE stores (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    name TEXT NOT NULL,
    address TEXT,
    phone TEXT,
    email TEXT,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### 9. **profiles** - Perfis de Usu√°rio
```sql
CREATE TABLE profiles (
    id UUID PRIMARY KEY REFERENCES auth.users(id),
    full_name TEXT,
    role TEXT CHECK (role IN ('employee', 'technician', 'admin', 'owner')),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    email TEXT
);
```

#### 10. **user_store_permissions** - Permiss√µes de Usu√°rio
```sql
CREATE TABLE user_store_permissions (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    user_id UUID REFERENCES auth.users(id),
    store_id BIGINT REFERENCES stores(id),
    can_manage_products BOOLEAN DEFAULT false,
    can_manage_sales BOOLEAN DEFAULT false,
    can_manage_service_orders BOOLEAN DEFAULT false,
    can_manage_cash_register BOOLEAN DEFAULT false,
    can_view_reports BOOLEAN DEFAULT false,
    can_manage_customers BOOLEAN DEFAULT false,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    can_manage_users BOOLEAN DEFAULT false,
    can_manage_cost_prices BOOLEAN DEFAULT false,
    can_manage_os_expiration BOOLEAN DEFAULT false
);
```

### Tabelas Auxiliares

#### **categories** - Categorias
```sql
CREATE TABLE categories (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    name TEXT UNIQUE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    store_id BIGINT REFERENCES stores(id)
);
```

#### **brands** - Marcas
```sql
CREATE TABLE brands (
    id INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    name VARCHAR UNIQUE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### **equipment_brands** - Marcas de Equipamentos
```sql
CREATE TABLE equipment_brands (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    name TEXT UNIQUE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### **service_order_products** - Produtos Usados em OS
```sql
CREATE TABLE service_order_products (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    service_order_id BIGINT REFERENCES service_orders(id),
    product_id BIGINT REFERENCES products(id),
    quantity INTEGER NOT NULL DEFAULT 1,
    unit_price NUMERIC(10,2) NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### Tabelas do Sistema Cl√≠nico (Legado)

#### **patients** - Pacientes
```sql
CREATE TABLE patients (
    id INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    full_name VARCHAR NOT NULL,
    birth_date DATE,
    gender VARCHAR,
    phone VARCHAR,
    email VARCHAR,
    address TEXT,
    health_insurance_id INTEGER REFERENCES health_insurances(id),
    emergency_contact_name VARCHAR,
    emergency_contact_phone VARCHAR,
    health_observations TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### **appointments** - Consultas
```sql
CREATE TABLE appointments (
    id INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    patient_id INTEGER REFERENCES patients(id),
    procedure_id INTEGER REFERENCES procedures(id),
    specialty_id INTEGER REFERENCES specialties(id),
    health_insurance_id INTEGER REFERENCES health_insurances(id),
    appointment_date DATE NOT NULL,
    appointment_time TIME NOT NULL,
    duration_minutes INTEGER DEFAULT 30,
    status VARCHAR DEFAULT 'scheduled',
    notes TEXT,
    room_number VARCHAR,
    doctor_name VARCHAR,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

## üîß Edge Functions

### 1. **create-user** - Cria√ß√£o de Usu√°rios
```typescript
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type"
};

serve(async (req) => {
  if (req.method === "OPTIONS") {
    return new Response("ok", { headers: corsHeaders });
  }

  try {
    const { email, password, fullName, role } = await req.json();
    
    const validRoles = ['employee', 'technician', 'admin', 'owner'];
    if (!validRoles.includes(role)) {
      throw new Error(`Fun√ß√£o inv√°lida: ${role}`);
    }

    const supabaseAdmin = createClient(
      Deno.env.get("SUPABASE_URL") ?? "",
      Deno.env.get("SUPABASE_SERVICE_ROLE_KEY") ?? ""
    );

    const { data: authData, error: authError } = await supabaseAdmin.auth.admin.createUser({
      email,
      password,
      email_confirm: true,
      user_metadata: {
        full_name: fullName,
        role: role
      }
    });

    if (authError) throw authError;
    const user = authData.user;

    const { error: profileError } = await supabaseAdmin
      .from("profiles")
      .upsert({
        id: user.id,
        full_name: fullName,
        role: role,
        email: email
      }, { onConflict: 'id' });

    if (profileError) {
      await supabaseAdmin.auth.admin.deleteUser(user.id);
      throw profileError;
    }

    return new Response(JSON.stringify({ user }), {
      headers: { ...corsHeaders, "Content-Type": "application/json" },
      status: 200
    });
  } catch (error) {
    return new Response(JSON.stringify({ error: error.message }), {
      headers: { ...corsHeaders, "Content-Type": "application/json" },
      status: 400
    });
  }
});
```

### 2. **get-users** - Listar Usu√°rios
```typescript
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type"
};

serve(async (req) => {
  if (req.method === "OPTIONS") {
    return new Response("ok", { headers: corsHeaders });
  }

  try {
    const supabaseAdmin = createClient(
      Deno.env.get("SUPABASE_URL") ?? "",
      Deno.env.get("SUPABASE_SERVICE_ROLE_KEY") ?? ""
    );

    const { data, error } = await supabaseAdmin.auth.admin.listUsers();
    if (error) throw error;

    return new Response(JSON.stringify(data), {
      headers: { ...corsHeaders, "Content-Type": "application/json" },
      status: 200
    });
  } catch (error) {
    return new Response(JSON.stringify({ error: error.message }), {
      headers: { ...corsHeaders, "Content-Type": "application/json" },
      status: 400
    });
  }
});
```

### 3. **delete-user** - Deletar Usu√°rio
```typescript
import "jsr:@supabase/functions-js/edge-runtime.d.ts";
import { createClient } from 'jsr:@supabase/supabase-js@2';

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
  'Access-Control-Allow-Methods': 'POST, OPTIONS'
};

Deno.serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders });
  }

  try {
    const { userId } = await req.json();
    if (!userId) {
      return new Response(JSON.stringify({ error: 'userId is required' }), {
        status: 400,
        headers: { ...corsHeaders, 'Content-Type': 'application/json' }
      });
    }

    const supabase = createClient(
      Deno.env.get('SUPABASE_URL'),
      Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')
    );

    // Excluir permiss√µes
    await supabase.from('user_store_permissions').delete().eq('user_id', userId);
    
    // Excluir perfil
    await supabase.from('profiles').delete().eq('id', userId);
    
    // Excluir usu√°rio do Auth
    const { error: deleteError } = await supabase.auth.admin.deleteUser(userId);
    if (deleteError) throw deleteError;

    return new Response(JSON.stringify({ success: true }), {
      status: 200,
      headers: { ...corsHeaders, 'Content-Type': 'application/json' }
    });
  } catch (error) {
    return new Response(JSON.stringify({ error: error.message }), {
      status: 500,
      headers: { ...corsHeaders, 'Content-Type': 'application/json' }
    });
  }
});
```

### 4. **get-user-profile** - Obter Perfil do Usu√°rio
```typescript
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type"
};

serve(async (req) => {
  if (req.method === "OPTIONS") {
    return new Response("ok", { headers: corsHeaders });
  }

  try {
    const { userId } = await req.json();
    if (!userId) {
      throw new Error("userId √© obrigat√≥rio");
    }

    const supabaseAdmin = createClient(
      Deno.env.get("SUPABASE_URL") ?? "",
      Deno.env.get("SUPABASE_SERVICE_ROLE_KEY") ?? ""
    );

    const { data: profile, error } = await supabaseAdmin
      .from('profiles')
      .select('*')
      .eq('id', userId)
      .single();

    if (error) throw error;

    return new Response(JSON.stringify({ profile }), {
      headers: { ...corsHeaders, "Content-Type": "application/json" },
      status: 200
    });
  } catch (error) {
    return new Response(JSON.stringify({ error: error.message }), {
      headers: { ...corsHeaders, "Content-Type": "application/json" },
      status: 400
    });
  }
});
```

### 5. **update-user-role** - Atualizar Fun√ß√£o do Usu√°rio
```typescript
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type"
};

serve(async (req) => {
  if (req.method === "OPTIONS") {
    return new Response("ok", { headers: corsHeaders });
  }

  try {
    const { userId, newRole } = await req.json();
    
    if (!userId || !newRole) {
      throw new Error("userId e newRole s√£o obrigat√≥rios");
    }

    const validRoles = ['employee', 'technician', 'admin', 'owner'];
    if (!validRoles.includes(newRole)) {
      throw new Error(`Fun√ß√£o inv√°lida: ${newRole}`);
    }

    const supabaseAdmin = createClient(
      Deno.env.get("SUPABASE_URL") ?? "",
      Deno.env.get("SUPABASE_SERVICE_ROLE_KEY") ?? ""
    );

    const { data: updateData, error: profileError } = await supabaseAdmin
      .from('profiles')
      .update({ role: newRole })
      .eq('id', userId)
      .select();

    if (profileError) throw profileError;

    // Atualizar user_metadata
    await supabaseAdmin.auth.admin.updateUserById(userId, {
      user_metadata: { role: newRole }
    });

    return new Response(JSON.stringify({
      success: true,
      message: `Fun√ß√£o do usu√°rio atualizada para ${newRole}`,
      data: updateData
    }), {
      headers: { ...corsHeaders, "Content-Type": "application/json" },
      status: 200
    });
  } catch (error) {
    return new Response(JSON.stringify({ error: error.message }), {
      headers: { ...corsHeaders, "Content-Type": "application/json" },
      status: 400
    });
  }
});
```

## üîê Configura√ß√µes de Seguran√ßa (RLS)

### Row Level Security (RLS)
Todas as tabelas principais devem ter RLS habilitado:

```sql
-- Habilitar RLS em todas as tabelas
ALTER TABLE service_orders ENABLE ROW LEVEL SECURITY;
ALTER TABLE customers ENABLE ROW LEVEL SECURITY;
ALTER TABLE products ENABLE ROW LEVEL SECURITY;
ALTER TABLE sales ENABLE ROW LEVEL SECURITY;
ALTER TABLE cash_registers ENABLE ROW LEVEL SECURITY;
ALTER TABLE cash_register_entries ENABLE ROW LEVEL SECURITY;
ALTER TABLE warranties ENABLE ROW LEVEL SECURITY;
ALTER TABLE stores ENABLE ROW LEVEL SECURITY;
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE user_store_permissions ENABLE ROW LEVEL SECURITY;
ALTER TABLE categories ENABLE ROW LEVEL SECURITY;
```

### Pol√≠ticas de Seguran√ßa Essenciais

```sql
-- Pol√≠tica para profiles - usu√°rios podem ver todos os perfis autenticados
CREATE POLICY "Allow authenticated users to select all profiles" ON profiles
FOR SELECT TO authenticated USING (true);

-- Pol√≠tica para service_orders - usu√°rios autenticados podem ver todas as OS
CREATE POLICY "Allow authenticated users to select all service orders" ON service_orders
FOR SELECT TO authenticated USING (true);

-- Pol√≠tica para customers - permitir leitura an√¥nima
CREATE POLICY "Allow anonymous read access to customers" ON customers
FOR SELECT TO anon USING (true);
```

## üöÄ Passos para Duplica√ß√£o

### 1. Criar Novo Projeto Supabase
1. Acesse [supabase.com](https://supabase.com)
2. Crie uma nova organiza√ß√£o/projeto
3. Anote a URL e as chaves do projeto

### 2. Executar Migra√ß√µes
1. Execute as migra√ß√µes na ordem cronol√≥gica (ver lista de migra√ß√µes acima)
2. Ou use o SQL Editor para executar os scripts de cria√ß√£o das tabelas

### 3. Configurar Edge Functions
1. No painel do Supabase, v√° em "Edge Functions"
2. Crie cada fun√ß√£o com o c√≥digo fornecido acima
3. Configure as vari√°veis de ambiente necess√°rias

### 4. Configurar RLS e Pol√≠ticas
1. Habilite RLS em todas as tabelas
2. Crie as pol√≠ticas de seguran√ßa necess√°rias

### 5. Inserir Dados Iniciais
```sql
-- Inserir lojas iniciais
INSERT INTO stores (name, address, phone, email) VALUES 
('Loja Principal', 'Endere√ßo da loja', '(11) 99999-9999', 'contato@alexcell.com'),
('Filial', 'Endere√ßo da filial', '(11) 88888-8888', 'filial@alexcell.com');

-- Criar usu√°rio owner inicial
-- (Usar a Edge Function create-user para isso)
```

### 6. Configurar Autentica√ß√£o
1. Configure os provedores de autentica√ß√£o desejados
2. Configure as URLs de redirecionamento
3. Configure as pol√≠ticas de senha

### 7. Testar Funcionalidades
1. Teste a cria√ß√£o de usu√°rios
2. Teste as permiss√µes
3. Teste as opera√ß√µes CRUD b√°sicas

## üìù Observa√ß√µes Importantes

- **Backup**: Sempre fa√ßa backup antes de executar migra√ß√µes
- **Ambiente**: Teste primeiro em ambiente de desenvolvimento
- **Chaves**: Mantenha as chaves de API seguras
- **RLS**: Verifique se todas as pol√≠ticas de seguran√ßa est√£o funcionando
- **Migra√ß√µes**: Execute as migra√ß√µes na ordem correta

## üîß Fun√ß√µes Auxiliares

### Fun√ß√£o para Decrementar Estoque
```sql
CREATE OR REPLACE FUNCTION decrement_stock(product_id_param bigint, quantity_param integer)
RETURNS void AS $$
BEGIN
    UPDATE products 
    SET stock_quantity = stock_quantity - quantity_param
    WHERE id = product_id_param;
END;
$$ LANGUAGE plpgsql;
```

### Fun√ß√£o para Incrementar Estoque
```sql
CREATE OR REPLACE FUNCTION increment_stock(product_id_param bigint, quantity_param integer)
RETURNS void AS $$
BEGIN
    UPDATE products 
    SET stock_quantity = stock_quantity + quantity_param
    WHERE id = product_id_param;
END;
$$ LANGUAGE plpgsql;
```

### Trigger para Novos Usu√°rios
```sql
CREATE OR REPLACE FUNCTION handle_new_user()
RETURNS trigger AS $$
BEGIN
    INSERT INTO public.profiles (id, full_name, email, role)
    VALUES (
        new.id,
        new.raw_user_meta_data->>'full_name',
        new.email,
        COALESCE(new.raw_user_meta_data->>'role', 'employee')
    );
    RETURN new;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER on_auth_user_created
    AFTER INSERT ON auth.users
    FOR EACH ROW EXECUTE PROCEDURE handle_new_user();
```

Este guia cont√©m todas as informa√ß√µes necess√°rias para recriar completamente o projeto AlexCell em uma nova inst√¢ncia do Supabase. Siga os passos na ordem e teste cada etapa antes de prosseguir.